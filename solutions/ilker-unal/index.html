<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Hello, PubNub</title>
    <!-- Update this block with the URL to the content delivery network version of the SDK -->
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.2.js"></script>
  </head>
  <body>
    <script>
      const buttonClick = () => {
        var input = document.getElementById('message-body');
        publishMessage(input.value);
        input.value = '';
      };

      const showMessage = (msg, publisher) => {
        var message = document.createElement('div');
        message.innerText = msg + ` ${publisher}`;
        document.getElementById('messages').appendChild(message);
      };

      let pubnub;

      const setupPubNub = () => {
        const id = self.crypto.randomUUID();
        // I have no idea why when I sent a message appears twice, each user has different id
        console.log({ id });
        // Update this block with your publish/subscribe keys
        pubnub = new PubNub({
          publishKey: 'pub-c-22282fdd-5100-467e-ace8-ffadd421656d',
          subscribeKey: 'sub-c-c6dfb65f-428b-4c64-a2ad-e065935d4e60',
          userId: id,
        });

        // add listener
        const listener = {
          status: (statusEvent) => {
            console.log({ statusEvent });
            if (statusEvent.category === 'PNConnectedCategory') {
              console.log('Connected');
            }
          },
          message: (messageEvent) => {
            console.log({ messageEvent });

            showMessage(
              messageEvent.message.description,
              messageEvent.publisher
            );
          },
          presence: (presenceEvent) => {
            console.log('presence', { presenceEvent });
            // handle presence
          },
        };
        pubnub.addListener(listener);

        // subscribe to a channel
        pubnub.subscribe({
          channels: ['hello_world'],
        });
      };

      // run after page is loaded
      window.onload = setupPubNub;

      // publish message
      const publishMessage = async (message) => {
        // With the right payload, you can publish a message, add a reaction to a message,
        // send a push notification, or send a small payload called a signal.
        const publishPayload = {
          channel: 'hello_world',
          message: {
            title: 'greeting',
            description: message,
          },
        };
        await pubnub.publish(publishPayload);
        try {
          const result = await pubnub.hereNow({
            channels: ['hello_world'],
          });
          console.log({ result });
        } catch (status) {
          console.log(status);
        }
      };
    </script>

    <div>
      <input id="message-body" type="text" />
      <button onclick="buttonClick()">Send</button>
      <div id="messages"></div>
    </div>
  </body>
</html>
